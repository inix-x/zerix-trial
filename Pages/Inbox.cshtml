@page
@model InboxModel
@{
    ViewData["Title"] = "Inbox";
    ViewData["User"] = "Admin";

    @* Inbox data *@
    ViewData["Inbox_Sender_Name"] = "Ana Santos";
    ViewData["Inbox_Sender_Number"] = "(+63 999 444 8888)";
}

<div class="container-fluid mt-md-4 mt-2 px-0">
    <div class="row no-gutters">
        <!-- Sidebar -->
        <nav class="col-md-4 d-none d-md-block sidebar">
            <ul class="navbar-nav pb-2 mb-4">
                <li class="nav-item dropdown d-none d-sm-block">
                    <a class="fs-5 nav-link text-dark d-flex flex-row align-items-center justify-content-between btn-orange border-orange py-2 px-4 px-md-4 py-md-3" href="#" id="navbarDropdownMenuLink2" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                        <div class="d-flex align-items-center px-2">
                            <img src="~/images/icons/department.svg" height="24" width="24" alt="Department" class="d-inline-block align-top me-3 color-primary" />
                            <span class="txt-color-primary fs-20 fw-400 me-2">Departments</span>
                        </div>
                        <img src="~/images/icons/arrow-down.svg" height="14" width="14" alt="arrow-down" class="d-inline-block" />
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdownMenuLink2">
                        <li><a class="dropdown-item" href="#">Department 1</a></li>
                        <li><a class="dropdown-item" href="#">Department 2</a></li>
                    </ul>
                </li>
            </ul>
            
            <ul class="nav flex-column pt-4 mt-4">
                <li class="nav-item">   
                    <a class="nav-link py-2 px-4 options rounded-top d-flex align-items-center" href="/">
                        <img src="~/images/icons/edit.svg" height="24" width="24" alt="Compose" class="d-inline-block me-2" />
                        <span class="fs-20  ff-microsoft-sans-serif px-2 py-2">Compose</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link py-2 px-4 options options-border d-flex align-items-center active custom-active" href="/Inbox">
                        <img src="~/images/icons/mail-active.svg" height="24" width="24" alt="Inbox" class="d-inline-block me-2" />
                        <span class="fs-20  ff-microsoft-sans-serif px-2 py-2">Inbox</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link py-2 px-4 options options-border d-flex align-items-center" href="#">
                        <img src="~/images/icons/sent.svg" height="24" width="24" alt="Sent" class="d-inline-block me-2" />
                        <span class="fs-20  ff-microsoft-sans-serif px-2 py-2">Sent</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link py-2 px-4 options options-border d-flex align-items-center" href="#">
                        <img src="~/images/icons/outbox.svg" height="24" width="24" alt="Outbox" class="d-inline-block me-2" />
                        <span class="fs-20  ff-microsoft-sans-serif px-2 py-2">Outbox</span>
                    </a>
                </li>
            </ul>
        </nav>
        <!-- Sidebar for Mobile View -->
        <nav class="sidebar-mobile d-md-none">
            <!-- Department Dropdown Button -->
            <div class="d-flex align-items-center py-2">
                <a class="box nav-link txt-color-primary d-flex justify-content-center btn-orange border-orange"  href="#" data-bs-toggle="offcanvas" data-bs-target="#departmentOffcanvas" aria-controls="departmentOffcanvas">
                    <img src="~/images/icons/department.svg" alt="Department" height="20" width="20" class="d-inline-block" />
                    <img src="~/images/icons/arrow-down.svg" height="12" width="12" alt="arrow-down" class="d-inline-block ms-1" />
                </a>
            </div>
            
            <!-- Icons for Mobile Sidebar -->
            <div class="d-flex gap-2 justify-content-end">
                <a class="box bg-orange-light d-flex align-items-center justify-content-center p-2" href="/">
                    <i class="bi bi-pencil-square"></i>
                </a>
                <a class="box bg-orange d-flex align-items-center justify-content-center p-2 active" href="/Inbox">
                    <i class="bi bi-envelope"></i>
                </a>
                <a class="box bg-orange-light d-flex align-items-center justify-content-center p-2" href="#">
                    <i class="bi bi-arrow-right-circle"></i>
                </a>
                <a class="box bg-orange-light d-flex align-items-center justify-content-center p-2" href="#">
                    <i class="bi bi-arrow-up-circle"></i>
                </a>
            </div>
        </nav>

        <div class="offcanvas offcanvas-bottom" tabindex="-2" id="departmentOffcanvas" aria-labelledby="departmentOffcanvasLabel">
            <div class="offcanvas-body">
                <ul class="navbar-nav">
                    <li><a class="nav-link txt-color-secondary" href="#">Department 1</a></li>
                    <li><a class="nav-link txt-color-secondary" href="#">Department 2</a></li>
                </ul>
            </div>
        </div>
        <!-- Main Content -->
        <main class="col-md-8 ms-sm-auto message-compose px-md-4">
            <div class="mb-md-4 d-flex align-items-center justify-content-between">
                <h1 class="fs-24 fw-normal d-none d-md-block txt-color-secondary">INBOX</h1>
                <a class="d-none d-md-block btn-orange border-orange txt-color-primary px-4 py-2" href="#">Export File</a>
                <a class="export-file-link-mobile d-md-none txt-color-primary text-end" href="#">Export File</a>
            </div>

            <div class="card">
                <div class="card-header px-0 py-0">
                    <!-- Sender Info -->
                    <div class="txt-color-primary-alt message-header-bg-color message-header d-flex justify-content-between flex-column flex-md-row">
                        <div class="d-flex justify-content-between w-200 p-2 px-md-4 px-4 py-2">
                            <div class="d-flex flex-column flex-md-row align-items-md-center">
                                <span class="d-none d-md-inline fs-4 me-md-4">@ViewData["Inbox_Sender_Name"]</span>
                                <!-- Show this element only on mobile (xs and sm screens) -->
                                <span class="d-md-none fs-5 me-md-4">@ViewData["Inbox_Sender_Name"]</span>
                                <span class="fs-6">@ViewData["Inbox_Sender_Number"]</span>
                            </div>
                            <!-- Icons for search and settings in mobile view -->
                            <div class="d-md-none d-flex align-items-center justify-content-end">
                                <button class="search-mobile-button btn p-0 me-3" type="button" onclick="toggleSearchBarMobile()">
                                    <i class="bi bi-search fs-5 txt-color-primary-alt"></i>
                                </button>
                                <button class="btn p-0" type="button">
                                    <i class="bi bi-gear fs-5 txt-color-primary-alt"></i>
                                </button>
                            </div>
                        </div>
                        <!-- Search and settings for desktop view -->
                        <div class="d-none d-md-flex align-items-center px-md-4 py-md-1">
                            <div class="input-group search-container">
                                <span class="input-group-text bg-white border-0 rounded-start" id="search-icon">
                                    <i class="bi bi-search"></i>
                                </span>
                            <input type="text" class="form-control rounded-end py-1" placeholder="Search" aria-label="Search" aria-describedby="search-icon">
                                <button class="btn btn-outline-transparent txt-color-primary-alt ms-2 gear-button" type="button">
                                    <i class="bi bi-gear"></i>
                                </button>
                            </div>   
                        </div>
                    </div>

                    <!-- Search bar for mobile view, hidden by default -->
                    <div id="mobileSearchContainer" class="w-100"></div>
                </div>
                <div class="card-body py-0 ps-0 pe-1 message-body-parent">
                    <!-- Message Thread - Received -->
                    <div id="messageBody" class="message-body pt-4 my-0 mx-0 pe-3">
                        @for (int i = 0; i < Model.Messages.Count; i++)
                        {
                            var message = Model.Messages[i];
                            if (message.IsSent)
                            {
                                <div class="message message-sent mb-3">
                                    <div class="d-flex justify-content-end align-items-center">
                                        <button class="btn btn-outline-transparent txt-color-primary-alt rounded border-0 me-1 reply" type="button">
                                            <i class="bi bi-reply txt-color-primary"></i>
                                        </button>
                                        <div class="rounded message-box px-4 py-4">
                                            <p class="message-text fs-14">@message.Content</p>
                                            <small class="text-muted d-block text-end"></small>
                                        </div>
                                    </div>
                                    <small class="text-muted mt-2 d-block text-end">@message.Timestamp</small>
                                </div>
                            }
                            else
                            {
                                <div class="message message-received mb-3 ms-3">
                                    <div class="d-flex justify-content-start align-items-center">
                                        <div class="rounded message-box px-4 py-4">
                                            <pre class="message-text fs-14">@message.Content</pre>
                                            <small class="text-muted d-block text-end">Via SMS</small>
                                        </div>
                                        <button class="btn btn-outline-transparent txt-color-primary-alt rounded border-0 ms-1 reply" type="button">
                                            <i class="bi bi-reply txt-color-primary"></i>
                                        </button>
                                    </div>
                                    <small class="text-muted mt-2 d-block">@message.Timestamp</small>
                                </div>
                            }
                        }
                    </div>
                </div>
            </div>

            <!-- Message Input -->
            <div class="mt-4">
                <label class="form-label txt-color-primary mb-2 cursor-pointer" onchange="useTemplate()">
                    Use Template
                    </label>
                <form method="post" enctype="multipart/form-data">
                    <div class="input-group rounded border px-2 py-1 px-md-3 py-md-2 d-flex align-items-center">
                        <label class="input-group-text bg-white border-0 cursor-pointer p-1 py-md-4 px-md-2">
                            <input type="file" name="files" multiple hidden accept=".pdf, .doc, .docx, .xls, .xlsx, .txt" onchange="displayUploadedFiles(this)">
                            <i class="bi bi-paperclip txt-color-primary fs-5"></i>
                        </label>

                        <label class="input-group-text bg-white border-0 cursor-pointer p-1 py-md-4 me-2">
                            <input type="file" name="audioFiles" multiple hidden accept="audio/*" onchange="displayUploadedFiles(this)">
                            <i class="bi bi-mic txt-color-primary fs-5"></i>
                        </label>

                        <textarea class="form-control border-0 py-2" placeholder="Enter your message" aria-label="Enter your message"></textarea>

                        <button class="btn btn-orange send-button p-0 " type="button">
                            <img src="~/images/icons/send.svg" alt="Logo" height="20" width="20" class="me-md-1"/>
                        </button>
                    </div>
                </form>

                <div class="attached-files mt-3">
                    @foreach (var file in Model.UploadedFiles)
                    {
                        <span class="attached-file-badge d-flex align-items-center">
                            <i class="bi bi-file-earmark-text-fill me-2"></i> @file.FileName
                            <button type="button" class="btn-close ms-2" aria-label="Remove"></button>
                        </span>
                    }
                </div>
            </div>
       </main>
    </div>
</div>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        var messageBody = document.getElementById("messageBody");
        messageBody.scrollTop = messageBody.scrollHeight;
    });
    let isSearchBarVisible = false; // Flag to track the visibility of the search bar

    function toggleSearchBarMobile() {
        const mobileSearchContainer = document.getElementById('mobileSearchContainer');

        if (!isSearchBarVisible) {
            // Add the search bar dynamically
            mobileSearchContainer.innerHTML = `
                <div class="d-md-none search-bar-mobile d-flex align-items-center w-100 px-3 py-2 hidden">
                    <input type="text" class="form-control py-1" placeholder="Search Conversation" aria-label="Search" id="searchInputMobile" onblur="hideSearchBarMobile()">
                </div>
            `;
            isSearchBarVisible = true; // Update the flag

            // Add an event listener for blur event to hide search bar on losing focus
            document.getElementById('searchInputMobile').addEventListener('blur', removeSearchBarMobile);

        } else {
            removeSearchBarMobile();
        }
    }

    function removeSearchBarMobile() {
        const mobileSearchContainer = document.getElementById('mobileSearchContainer');
        mobileSearchContainer.innerHTML = ''; // Clear the content to remove the search bar
        isSearchBarVisible = false; // Update the flag
    }

    function useTemplate(){
        console.log("Use template clicked!");
    }

    function displayUploadedFiles(input) {
        const files = input.files;
        const container = document.querySelector('.attached-files');

        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            const fileType = file.type; 
            const fileName = file.name;
            const fileExtension = fileName.split('.').pop().toLowerCase();

            let fileIcon = getFileIcon(fileExtension);

            const fileBadge = document.createElement('span');
            fileBadge.classList.add('bg-orange-light', 'text-black', 'px-3', 'py-2', 'attached-file-badge', 'd-flex', 'align-items-center');
            
            fileBadge.innerHTML = `
                <i class="${fileIcon} me-2"></i> ${fileName}
                <button type="button" class="btn-close ms-2" aria-label="Remove" onclick="removeFile(this)"></button>
            `;
            container.appendChild(fileBadge);
        }
    }


    function getFileIcon(extension) {
        switch (extension) {
            case 'pdf':
                return 'bi bi-file-earmark-pdf';
            case 'doc':
            case 'docx':
                return 'bi bi-file-earmark-word';
            case 'xls':
            case 'xlsx':
                return 'bi bi-file-earmark-spreadsheet';
            case 'txt':
                return 'bi bi-file-earmark-text';
            case 'mp3':
            case 'wav':
            case 'ogg':
                return 'bi bi-file-earmark-music';
            default:
                return 'bi bi-file-earmark';
        }
    }

    function removeFile(button) {
        const fileBadge = button.closest('span');
        fileBadge.remove();
    }

</script>